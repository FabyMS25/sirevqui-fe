<div class="modal-header bg-info-subtle p-2">
    <h5 class="modal-title" *ngIf="accion === ''" ngbAutofocus>
        <i class="ri-user-add-line me-2"></i>Agregar Encargado
    </h5>
    <h5 class="modal-title" *ngIf="accion === 'edit'" ngbAutofocus>
        <i class="ri-user-settings-line me-2"></i>Editar Datos de Encargado
    </h5>
    <button type="button" class="btn-close"
        data-dismiss="modal" aria-label="Cerrar"
        [disabled]="submitted" (click)="closeModal()">
    </button>
</div>

<form (ngSubmit)="saveData()" [formGroup]="contentForm" autocomplete="off">
    <div class="modal-body">
        <div class="row g-3">
            <div class="col-lg-12">
                <input type="hidden" name="uuid" value="" formControlName="uuid" />
                <div class="text-center ">
                    <div class="position-relative d-inline-block">
                        <div class="avatar-md border border-3 border-light shadow-sm rounded-circle bg-light">
                            <img [src]="'assets/icons/users/' + selectedAvatar" 
                                 class="avatar-lg rounded-circle object-fit-cover" 
                                 [alt]="getCurrentAvatarInfo().label"
                                 style="width: 100%; height: 100%;" />
                        </div>
                        <div class="position-absolute bottom-0 end-0">
                            <button type="button" 
                                    class="btn btn-light btn-sm rounded-circle p-2 shadow-sm"
                                    (click)="toggleAvatarSelection()"
                                    data-bs-toggle="tooltip"
                                    data-bs-placement="top" 
                                    title="Cambiar Avatar">
                                <i class="ri-image-edit-line"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mb-0">
                        <small class="text-muted">{{ getCurrentAvatarInfo().label }}</small>
                    </div>
                </div>
                <div class="card" *ngIf="showAvatarSelection">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">
                            <i class="ri-gallery-line me-2"></i>Seleccionar Avatar
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-4" *ngIf="getAvatarsByCategory('admin').length > 0">
                            <h6 class="text-primary mb-3">
                                <i class="ri-admin-line me-2"></i>Administradores
                            </h6>
                            <div class="row g-2">
                                <div class="col-3" *ngFor="let avatar of getAvatarsByCategory('admin')">
                                    <div class="text-center">
                                        <div class="avatar-selection-item position-relative cursor-pointer"
                                             [class.selected]="selectedAvatar === avatar.value"
                                             (click)="selectAvatar(avatar.value)">
                                            <img [src]="'assets/icons/users/' + avatar.value" 
                                                 class="avatar-sm rounded-circle border"
                                                 [alt]="avatar.label" />
                                            <div class="selection-overlay" *ngIf="selectedAvatar === avatar.value">
                                                <i class="ri-check-line text-white"></i>
                                            </div>
                                        </div>
                                        <small class="text-muted d-block mt-1">{{ avatar.gender === 'M' ? 'Masc.' : 'Fem.' }}</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mb-4" *ngIf="getAvatarsByCategory('operator').length > 0">
                            <h6 class="text-success mb-3">
                                <i class="ri-user-line me-2"></i>Operadores
                            </h6>
                            <div class="row g-2">
                                <div class="col-3" *ngFor="let avatar of getAvatarsByCategory('operator')">
                                    <div class="text-center">
                                        <div class="avatar-selection-item position-relative cursor-pointer"
                                             [class.selected]="selectedAvatar === avatar.value"
                                             (click)="selectAvatar(avatar.value)">
                                            <img [src]="'assets/icons/users/' + avatar.value" 
                                                 class="avatar-sm rounded-circle border"
                                                 [alt]="avatar.label" />
                                            <div class="selection-overlay" *ngIf="selectedAvatar === avatar.value">
                                                <i class="ri-check-line text-white"></i>
                                            </div>
                                        </div>
                                        <small class="text-muted d-block mt-1">{{ avatar.gender === 'M' ? 'Masc.' : 'Fem.' }}</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mb-4" *ngIf="getAvatarsByCategory('supervisor').length > 0">
                            <h6 class="text-warning mb-3">
                                <i class="ri-user-star-line me-2"></i>Supervisores
                            </h6>
                            <div class="row g-2">
                                <div class="col-3" *ngFor="let avatar of getAvatarsByCategory('supervisor')">
                                    <div class="text-center">
                                        <div class="avatar-selection-item position-relative cursor-pointer"
                                             [class.selected]="selectedAvatar === avatar.value"
                                             (click)="selectAvatar(avatar.value)">
                                            <img [src]="'assets/icons/users/' + avatar.value" 
                                                 class="avatar-sm rounded-circle border"
                                                 [alt]="avatar.label" />
                                            <div class="selection-overlay" *ngIf="selectedAvatar === avatar.value">
                                                <i class="ri-check-line text-white"></i>
                                            </div>
                                        </div>
                                        <small class="text-muted d-block mt-1">{{ avatar.gender === 'M' ? 'Masc.' : 'Fem.' }}</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3" *ngIf="getAvatarsByCategory('default').length > 0">
                            <h6 class="text-secondary mb-3">
                                <i class="ri-user-3-line me-2"></i>Perfiles Predeterminados
                            </h6>
                            <div class="row g-2">
                                <div class="col-3" *ngFor="let avatar of getAvatarsByCategory('default')">
                                    <div class="text-center">
                                        <div class="avatar-selection-item position-relative cursor-pointer"
                                             [class.selected]="selectedAvatar === avatar.value"
                                             (click)="selectAvatar(avatar.value)">
                                            <img [src]="'assets/icons/users/' + avatar.value" 
                                                 class="avatar-sm rounded-circle border"
                                                 [alt]="avatar.label" />
                                            <div class="selection-overlay" *ngIf="selectedAvatar === avatar.value">
                                                <i class="ri-check-line text-white"></i>
                                            </div>
                                        </div>
                                        <small class="text-muted d-block mt-1">General</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="text-end">
                            <button type="button" class="btn btn-sm btn-outline-secondary" 
                                    (click)="toggleAvatarSelection()">
                                <i class="ri-close-line me-1"></i>Cerrar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-12">
                    <label for="userUuid" class="form-label mb-0">
                        <i class="ri-user-line me-2"></i>Usuario <span class="text-danger">*</span>
                    </label>
                    <select class="form-select" id="userUuid" formControlName="userUuid" required
                        (change)="onUserSelectHandler($event)"
                        [ngClass]="{ 'is-invalid': submitted && form['userUuid'].errors }">
                        <option value="" disabled>Seleccione un usuario...</option>
                        <option [value]="user.uuid" *ngFor="let user of usersList">
                            {{ user.designacionFuncionarioDto?.personaDto?.fullName || user.username || 'Sin nombre' }}
                            <span *ngIf="user.designacionFuncionarioDto?.personaDto?.fullName && user.username">
                                ({{ user.username }})
                            </span>
                        </option>
                    </select>
                    <div *ngIf="submitted && form['userUuid'].errors" class="invalid-feedback">
                        <div *ngIf="form['userUuid'].errors['required']">
                            <i class="ri-error-warning-line me-1"></i>Debe seleccionar un Usuario
                        </div>
                    </div>
            </div>
            <div class="col-lg-6">
                    <label for="nombre-field" class="form-label mb-0">
                        <i class="ri-user-3-line me-2"></i>Nombre Completo <span class="text-danger">*</span>
                    </label>
                    <input type="text" 
                           class="form-control" 
                           id="nombre-field" 
                           formControlName="nombre"
                           placeholder="Ingrese el nombre completo del encargado"
                           [ngClass]="{ 'is-invalid': submitted && form['nombre'].errors }" />
                    <div *ngIf="submitted && form['nombre'].errors" class="invalid-feedback">
                        <div *ngIf="form['nombre'].errors['required']">
                            <i class="ri-error-warning-line me-1"></i>El nombre es requerido
                        </div>
                        <div *ngIf="form['nombre'].errors['minlength']">
                            <i class="ri-error-warning-line me-1"></i>El nombre debe tener al menos 2 caracteres
                        </div>
                        <div *ngIf="form['nombre'].errors['maxlength']">
                            <i class="ri-error-warning-line me-1"></i>El nombre no puede exceder los 100 caracteres
                        </div>
                    </div>
            </div>
            <div class="col-lg-6">
                    <label for="telefono-field" class="form-label mb-0">
                        <i class="ri-phone-line me-2"></i>Teléfono
                    </label>
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="ri-phone-fill"></i>
                        </span>
                        <input type="tel" 
                               class="form-control" 
                               id="telefono-field" 
                               formControlName="telefono"
                               placeholder="Ej: +591 70123456 o 70123456"
                               [ngClass]="{ 'is-invalid': form['telefono'].errors && (form['telefono'].touched || submitted) }" />
                    </div>
                    <div *ngIf="form['telefono'].errors && (form['telefono'].touched || submitted)">
                        <small class="text-danger d-block" *ngIf="form['telefono'].errors['pattern']">
                            <i class="ri-error-warning-line me-1"></i>Ingrese un número válido (7-15 dígitos, opcional +)
                        </small>
                        <small class="text-danger d-block" *ngIf="form['telefono'].errors['minlength']">
                            <i class="ri-error-warning-line me-1"></i>Mínimo 7 dígitos
                        </small>
                        <small class="text-danger d-block" *ngIf="form['telefono'].errors['maxlength']">
                            <i class="ri-error-warning-line me-1"></i>Máximo 15 dígitos
                        </small>
                    </div>
                    <small class="form-text text-muted pb-0">
                        <i class="ri-information-line me-1"></i>Formato internacional recomendado: +591 70123456
                    </small>
            </div>
            <div class="col-lg-12">
                    <label for="complejoDto" class="form-label mb-0">
                        <i class="ri-building-line me-2"></i>Complejo Deportivo <span class="text-danger">*</span>
                    </label>
                    <select class="form-select" id="complejoDto" formControlName="complejoDto" required
                            [compareWith]="compareComplejo"
                        [ngClass]="{ 'is-invalid': submitted && form['complejoDto'].errors }">
                        <option value="" disabled>Seleccione un complejo deportivo...</option>
                        <option [ngValue]="item" *ngFor="let item of canchasList">
                            {{ item.nombre }}
                        </option>
                    </select>
                    <div *ngIf="submitted && form['complejoDto'].errors" class="invalid-feedback">
                        <div *ngIf="form['complejoDto'].errors['required']">
                            <i class="ri-error-warning-line me-1"></i>Debe seleccionar un complejo deportivo
                        </div>
                    </div>
            </div>
            <div class="col-lg-6">
                    <label for="fechaAsignacion-field" class="form-label mb-0">
                        <i class="ri-calendar-line me-2"></i>Fecha de Asignación <span class="text-danger">*</span>
                    </label>
                    <input type="date" id="fechaAsignacion-field" 
                           class="form-control"
                           formControlName="fechaAsignacion"
                           [ngClass]="{ 'is-invalid': submitted && form['fechaAsignacion'].errors }" />
                    <div *ngIf="submitted && form['fechaAsignacion'].errors" class="invalid-feedback">
                        <div *ngIf="form['fechaAsignacion'].errors['required']">
                            <i class="ri-error-warning-line me-1"></i>La fecha de asignación es requerida
                        </div>
                    </div>
            </div>

            <div class="col-lg-6">
                    <label for="fechaFinAsignacion-field" class="form-label mb-0">
                        <i class="ri-calendar-check-line me-2"></i>Fecha Fin de Asignación
                    </label>
                    <input type="date" 
                           id="fechaFinAsignacion-field" 
                           class="form-control"
                           formControlName="fechaFinAsignacion" />
                    <small class="form-text text-muted">
                        <i class="ri-information-line me-1"></i>Opcional - Dejar vacío si es indefinido
                    </small>
            </div>
            <div class="col-lg-6">
                    <label for="horaEntrada-field" class="form-label mb-0">
                        <i class="ri-time-line me-2"></i>Hora de Entrada <span class="text-danger">*</span>
                    </label>
                    <input class="form-control" 
                           type="time" 
                           id="horaEntrada-field"
                           formControlName="horaEntrada"
                           [ngClass]="{ 'is-invalid': submitted && form['horaEntrada'].errors }" />
                    <div *ngIf="submitted && form['horaEntrada'].errors" class="invalid-feedback">
                        <div *ngIf="form['horaEntrada'].errors['required']">
                            <i class="ri-error-warning-line me-1"></i>La hora de entrada es requerida
                        </div>
                    </div>
            </div>

            <div class="col-lg-6">
                    <label for="horaSalida-field" class="form-label mb-0">
                        <i class="ri-time-fill me-2"></i>Hora de Salida <span class="text-danger">*</span>
                    </label>
                    <input class="form-control" 
                           type="time" 
                           id="horaSalida-field"
                           formControlName="horaSalida"
                           [ngClass]="{ 'is-invalid': submitted && form['horaSalida'].errors }" />
                    <div *ngIf="submitted && form['horaSalida'].errors" class="invalid-feedback">
                        <div *ngIf="form['horaSalida'].errors['required']">
                            <i class="ri-error-warning-line me-1"></i>La hora de salida es requerida
                        </div>
                    </div>
                    <div *ngIf="contentForm.errors?.['invalidTimeRange'] && submitted" 
                         class="text-danger small mt-1">
                        <i class="ri-error-warning-line me-1"></i>La hora de entrada debe ser menor que la hora de salida
                    </div>
            </div>
            <div class="col-lg-12">
                <div class="card bg-light border-0 mb-0">
                        <div class="form-check form-switch">
                            <input class="form-check-input" 
                                   type="checkbox" 
                                   role="switch"
                                   id="activo-field" 
                                   formControlName="activo">
                            <label class="form-check-label fw-medium" for="activo-field">
                                <i class="ri-user-check-line me-2"></i>Encargado Activo
                            </label>
                        </div>
                        <small class="text-muted">
                            <i class="ri-information-line me-1"></i>
                            Solo los encargados activos pueden gestionar el complejo asignado
                        </small>
                </div>
            </div>
        </div>

        <div class="card border-info mt-2" *ngIf="accion === 'edit' && row">
            <div class="card-header bg-info-subtle">
                <h6 class="mb-0">
                    <i class="ri-information-line me-2"></i>Información Actual
                </h6>
            </div>
            <!-- <div class="card-body p-3">
                <div class="row">
                    <div class="col-sm-6">
                        <small class="text-muted">Creado:</small>
                        <div class="fw-medium">{{ row.fechaCreacion | date:'dd/MM/yyyy HH:mm'}}</div>
                    </div>
                </div>
            </div> -->
        </div>
    </div>
    <div class="modal-footer bg-light py-1">
        <div class="d-flex justify-content-between w-100">
            <div class="d-flex align-items-center">
                <small class="text-muted">
                    <i class="ri-information-line me-1"></i>
                    <span class="text-danger">*</span> Campos obligatorios
                </small>
            </div>
            <div class="hstack gap-2">
                <button type="button" class="btn btn-light" 
                        [disabled]="submitted"
                        (click)="closeModal()">
                    <i class="ri-close-line me-1"></i>Cancelar
                </button>
                <button type="submit" 
                        class="btn btn-success"
                        [disabled]="submitted || contentForm.invalid"
                        id="add-btn">
                    <span *ngIf="submitted" class="spinner-border spinner-border-sm me-2" role="status"></span>
                    <i *ngIf="!submitted" [class]="accion === 'edit' ? 'ri-save-line me-1' : 'ri-add-line me-1'"></i>
                    {{ accion === 'edit' ? 'Actualizar Encargado' : 'Guardar Encargado' }}
                </button>
            </div>
        </div>
    </div>
</form>

<ng-template #deleteModel let-modal>
    <div class="modal-content" *ngIf="row.uuid">
        <div class="modal-header">
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="btn-close"
                (click)="modal.dismiss('Cross click')"></button>
        </div>
        <div class="modal-body">
            <div class="mt-2 text-center">
                <lord-icon src="https://cdn.lordicon.com/gsqxdxog.json" trigger="loop"
                    colors="primary:#405189,secondary:#f06548" style="width:90px;height:90px"></lord-icon>
                <div class="mt-4 pt-2 fs-15 mx-4 mx-sm-5">
                    <h4>¿Está seguro de eliminar el registro?</h4>
                    <p class="text-muted mx-4 mb-0">
                        Al confirmar la eliminación se quitará toda información de nuestra base de datos.
                    </p>
                </div>
            </div>
            <div class="d-flex gap-2 justify-content-center mt-4 mb-2">
                <button class="btn btn-link link-success fw-medium text-decoration-none" data-bs-dismiss="modal"
                    id="deleteRecord-close" (click)="modal.close('Close click')">
                    <i class="ri-close-line me-1 align-middle"></i> Cancelar
                </button>
                <button type="button" class="btn w-sm btn-danger" id="delete-product" (click)="deleteData(this.row.uuid)">
                    Sí, Eliminar!
                </button>
            </div>
        </div>
    </div>
</ng-template>